# 数据包隐写

CTF 比赛中，流量包的取证分析是另一项重要的考察方向。通常比赛中会提供一个包含流量数据的 PCAP 或者 pcapng 文件，有时候也会需要选手们先进行修复或重构传输文件后，再进行分析。PCAP/pcapng 这一块作为重点考察方向，复杂的地方在于数据包里充满着大量无关的流量信息，因此如何分类和过滤数据是参赛者需要完成的工作


Wireshark 简介和安装

Wireshark 前称( Ethereal ) 是一个网络封包分析软件。网络封包分析软件的功能是撷取网络封包，并尽可能显示出最为详细的网络封包资料。Wireshark 使用 WinPCAP 作为接口，直接与网卡进行数据报文交换


打开 Wireshark 后，能够看到三个区域，最上方是工具栏区域，可以开始捕获，停止捕获等操作。中间是 Capture Filter 区域，能够在开始捕获前指定过滤规则。最下方可以捕获的网络设备，双击其中一个设备后就可以开始进行网络流量的捕获。

结果的显示主要分三个区域，最上方是请求，响应列表，每一条记录表示一次请求或响应的交互。中间是对选中的交互解析后的结果。最下方是原始的数据格式

在请求列表上方，我们可以指定 Display Filter 用于筛选已经捕获到的数据。

Display Filter 的常用方法

过滤源ip，目的ip
在 Wireshark 的过滤规则框 Filter 中输入过滤条件。如查找目的地址为 192.168.101.8 的包 `ip.dst==192.168.101.8` 查找源地址为 `ip.src==1.1.1.1`

端口过滤
如过滤80 端口,在 Filter 中输入， tcp.port==80 这条规则是把源端口和目的端口为 80 的都过滤出来。使用 tcp.dstport==80 只过滤目的端口为 80 的 tcp.srcport==80 只过滤源端口为 80 的包 

协议过滤
比较简单,直接在 Filter 框中直接输入协议名即可，如过滤 HTTP 的协议

http模式过滤
如过滤 get 包 http.request.method=="GET" 过滤 post 包 http.request.method=="POST"

连接符 and 的使用
过滤两种条件时，使用and 连接，如过滤ip为 192.168.101.8 并且为 http 协议的 ip.src==192.168.101.8 and http

界面上一些小 Tips

左边的实线连起来的表示同以次会话发生的各个阶段。

## PCAP 数据包

PCAP 文件结构

一般来讲,对于 PCAP 文件格式考察比较少，且通常都能借助于现成的工具 如 pcapfix 直接修复，这里大致介绍下几个常见的块。

## 考察方式

总的来说比赛中的流量分析可以概括为以下三个方向。

+ 流量包修复
+ 协议分析
+ 数据提取

### 流量包修复
如果一个流量包文件头有损坏，或者文件头是对的，里边也没有包含其它的文件等等等等，但就是打开出现一些未知的错误，这时候就要考虑到对流量包进行修复。这类考题考察较少，通常都借助先成的工具 PCAPFIX 直接修复、


解决方法
+ PcapFIX Online https://f00l.de/hacking/pcapfix.php
+ PcapFix https://github.com/Rup0rt/pcapfix/tree/devel


### 协议分析

此类方向需要对分析流量包工具所用的语法有一定的掌握，这里以 Wireshark 为例，须掌握 Wireshark 过滤器 (捕捉过滤器与显示过滤器) 的基础语法，从而更快更准确的获取指定的信息。
捕捉过滤器: 用于决定将什么样的信息记录在捕捉结果中，需要在开始捕捉前设置

显示过滤器: 用于在捕捉结果中进行详细查找，可以在得到捕捉结果后进行更改


解决方法：
需要对各种协议有基础认识

熟练使用 Wireshark 的过滤功能可以事半功倍

### 数据提取

这一块是流量包中另一个重点,通过对协议分析，找到题目的关键点，从而对所需要的数据进行提取。可以学习一下tshark 的使用 tshark 作为 Wireshark 的命令行版，高效快捷是它的优点，配合其它命令行工具 (awk,grep) 等灵活使用，可以快速定位，提取数据从而省去了繁杂的脚本编写

// 提取 usb 数据包的 Leftover Capture Data 域
```bash
tshark -r keyboard.pcap -T fields -e usb.capdata > usbdata.txt
```
-s 只抓取前 512 字节
-i 捕获 eth0 网卡
-n 禁用完了对象名称解析
-f 只捕获协议为 tcp 目的端口为 80
-R 过滤出http.host 和 http.request.url;
-T,-e 指的是打印这两个字段
-I 输出到命令行界面


官方文档 ： https://www.wireshark.org/docs/man-pages/tshark.html
