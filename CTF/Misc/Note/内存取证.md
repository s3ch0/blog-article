# 内存取证

+ 内存取证工具 Volatility
+ CTF 中的考察方式

## Volatility 简介和安装

`Volatility` 是开源的 `Windows ,Linux, MacOS ,Android` 的内存取证分析工具,由 `python` 编写而成，支持命令行操作，支持各种操作系统，如 `Linux, MacOS, Windows`

项目地址 https://github.com/volatilityfoundation/volatility


### 安装

`Volatility2.6` 需要 `python2`，所以使用 `pip` 安装模块也需要 `python2` 版本，具体命令根据实际情况调整。

```bash
git clone https://github.com/volatilityfoundation/volatility
```
#### 安装依赖

在进行安装之前，我们一定有必要将下面的依赖安装完。

+ `crypto`

```bash
pip2 install pycryptodome
# 如果安装失败，可使用以下命令切换国内源
pip2 install pycryptodome -i https://pypi.tuna.tsinghua.edu.cn/simple
# 如果提示权限不够可以加sudo尝试一下
```
+ `distorm3`

安装这个依赖，我们只需要先将项目克隆下来
```bash
https://github.com/vext01/distorm3
```
下载解压或克隆后进入项目主目录使用 `python2 setup.py install` 进行编译

Volatility 还支持很多可选插件,他们能帮我们提供更丰富的功能.

```bash
Distorm3(反编译库)       # pip install distorm3
Yara(恶意软件分类工具)   # pip install yara
PyCrypto(加密工具集)     # pip install pycrypto
PIL(图片处理库)          # pip install pil
OpenPyxl(读写excel文件)  # pip install openpyxl
ujson(JSON解析)          # pip install ujson
```

#### 安装Volatility

当我们做完上面的步骤之后，我们就可以在解压后的 `Volatility` 目录下进行编译.

<font color="red"> 编译命令如下：</font>
```bash
python2 setup.py install 
```
#### 安装插件

**安装 `mimikatz`**

[mimikatz Download Link](https://github.com/RealityNet/hotoloti/blob/master/volatility/mimikatz.py)

+ 将 `mimikatz.py` 复制到 `volatility-master/volatility/plugins/` 目录下
+ 使用时需要添加参数 `--plugins=./volatility-master/volatility/plugins`

<div style="border-radius:15px;display:block;background-color:pink;border:2px solid #aaa;margin:15px;padding:10px;">运行时可能会出现如下错误，这是因为没有安装<code>construct</code> 模块</div>

```
Volatility Foundation Volatility Framework 2.6
*** Failed to import volatility.plugins.mimikatz (ImportError: No module named construct)
ERROR   : volatility.debug    : You must specify something to do (try -h)
```

安装 `construct` 模块的命令

```bash
pip2 install construct 
```
---

在分析之前，需要先判断当前镜像的信息，分析出是哪个操作系统

获取镜像系统类型

volatility imageinfo -f 文件名


Volatility 查看进程

volatility -f 文件名 dump的系统版本 命令
查看进程 用 pslist

volatility -f mem.dump --profile=Win7SP1x64 pslist


获取 CMD 输入

cmdscan 获取曾经在 cmd 上输入过的内容
filescan 获得文件

volatility -f mem.dump --profile=Win7SP1x64 cmdscan


## CTF 中的考察方式

+ 获取 Administrator 账户的密码
+ 借助 Elcomsoft Forensic Disk Decryptor 破解key

### 获取管理员密码

遇到需要获取 Administrator 账户的题目，我们可以通过查询 sam 表的方式查看哈希:

列举缓存在内存中的注册表

volatility -f mem.vmem -profile=WinXPSP2x86 hivelist

获取 SYSTEM SAM 的虚拟地址，分别 0xfffff8a000024010 0xfffff8a001590010

hashdump 获取用户密码的hash 然后去cmd5 这个网站进行爆破

volatility -f mem.dump --profile=Win7SP1x64 hashdump 0xfffff8a000024010 0xfffff8a001590010


### 借助 Elcomsoft Forensic Disk Decryptor 破解key

题目例子

[suspicion](./memory_forensics.assets/suspicion.7z)



发现存在TrueCrypt.exe进程，TrueCrypt.exe是一款加密程序，所以猜测Suspicion是加密后的结果。

使用命令vol.py -f mem.vmem --profile=WinXPSP2x86 memdump -p 2012 -D ./（-p是PID -D是转储路径）将进程转储出来得到2012.dmp。

volatility -f mem.vmem --profile=WinXPSP2x86 pslist
发现有 TrueCrypt.exe 的进程 TrueCrypt.exe 是一款加密软件，而我们可以推出，suspicion 为加密结果
我们需要从内存dump出key来


解决方法：
需要借助 Elcomsoft Forensic Disk Decryptor (Elcomsoft 硬盘取证解码器，简称为 EFDD) 软件来获取 key 和破解软件

[](https://www.bnessy.com/archives/%E7%94%B5%E5%AD%90%E6%95%B0%E6%8D%AE%E5%8F%96%E8%AF%81-volatility)
