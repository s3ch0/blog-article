

## 缓解措施

操作系统提供了许多安全机制来尝试降低或阻止缓冲区溢出攻击带来的安全风险,包括DEP,ASLR等.在编写漏洞利用代码的时候,需要特别注意目标进程是否开启了DEP(Linux下对应NX),ASLR(Linux下对应PIE)等机制,例如: 存在DEP(NX)的话就不能直接执行栈上的数据,存在ASLR的话各个系统调用的地址就是随机化的.


我们可以使用 checksec 这个工具来检查程序的保护措施。
`checksec executeable_file`

### PIE



(基于 ALSR 实现的)
内存中最重要的一个概念就是地址，类似门牌号，只有拿着正确的地址才能找到正确的数据。


在二进制漏洞利用过程中地址是很重要的一个参量。例如内存中某个位置存在有价值的数据，如果想要泄露这些数据，就必须得到正确的内存地址。

在没有开启任何保护的情况下，程序会被加载到一个固定的地址上，这表示文明根据这个固定地址加上偏移量即可得到有效地址，而且偏移量通常可以通过逆向手段确定。

为了增加攻击者定位内存数据的难度，编译器提供 PIE 保护选项。开启时， <font color="red"> 程序会被胡乱加载到内存随机的位置，并且这个位置只有操作系统才知道。 </font> 如此攻击者想要定位内存数据就非常困难了。


### NX

内存中另外一个重要概念就是分段和分页，这些属于操作系统的知识，我们这里只简单介绍和权限有关的内容。

由于分段的特性，一个程序在内存中可分为代码段，数据段等，类似于 Linux 中的文件权限，每个段拥有不同的权限。可简单分为 可否读(R read) 可否写(W write) 可否执行 (X execute). 只有拥有可执行权限的段中的内容才能被 CPU 执行。当系统监测到从不可执行段上获取指令的操作时，就会结束当前进程。

NX 就是这样一种技术，通过修改段的权限设置，将没有必要的权限移除，例如数据段不需要可执行权限，代码段不需要可写权限等。如此攻击者就不能胡乱劫持程序执行流，或修改已经存在的代码了。

> PS: 相当于给每个段发员工卡，你只能做自己分内的事情。

### Canary

CANNARY 字面意思是金丝雀.来源于英国矿井工人用来探查井下气体是否有毒的金丝雀笼子。工人们每次下井都会带上一只金丝雀。如果井下的气体有毒，金丝雀由于对毒性敏感就会停止鸣叫甚至死亡，从而使工人们得到预警

之前我们说到栈的一些知识，在没有任何保护的情况下，一旦反生溢出，系统会完全暴露在风险之下。而 canary 就是在 ebp 的位置上方插入了一条独特的数据，这个数据是不可预测的。在执行某些重要操作之前会首先检查这个数据有没有被改动，如果被改动了，进程会直接退出。这样就起到了对栈溢出的一种缓解作用。

栈溢出包含是一种缓冲区溢出攻击缓解手段,当函数存在缓冲区溢出攻击漏洞时,攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行.当启动栈保护后,函数开始执行的时候会先往栈里插入cookie信息,当函数真正返回的时候会验证cookie是否合法,如果不合法就停止程序运行.攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉,导致栈保护检查失败而阻止shellcode的执行,在linux中我们将cookie信息称为canary.

> PS: 相当与雇佣一个放哨的，发现出现异常情况就通报。

`.text` 是程序的代码段，所有可被 CPU 执行的机器码都位于  `.text` 段中.
所谓 ret2text 就是控制程序执行流返回到程序自身。实际上之前演示中就用到了这种方法。

实际情况是，某些程序会用到  `system,execve` 等函数来执行系统命令。例如路由器固件，常常需要使用  `execve` 来进行如防火墙，网站过滤等设置。而当其中某处发生栈溢出时，我们可以直接利用程序中自带的 `execve system`  等函数获取  `shell`
像这种控制执行流到程序自身的行为就叫做  `ret2text`,是最基本的 ROP 手段。


## 利用手法


## shellcode

shellcode 的一小段代码，可以用于软件漏洞利用的载荷。被称为 "ShellCode" 是因为它通常启动一个命令终端，攻击者可以通过这个终端控制受害者的计算机，但是所有执行类似任务的代码片段都可以称为 shellcode Shellcode 通常是以机器码形式编写的。

一般通过编写汇编语言后将其编译得到所需的 shellcode

套用 asm 函数就可以得到对应的 shellcode,但是 <font color="red"> 注意在调用前需要设置好对应的框架。 </font>




## ret2shellcode

那么我们现在需要的就是一个 jmp esp 的地址

这里我们选择使用 ROPgadget 和ropper 两个工具来查找

这两个工具在之后也会经常用到。

1. ROPgadget --binary ret2shellcode --only "jmp"

2. ropper



[exploit-db](https://www.exploit-db.com/)

https://www.exploit-db.com/shellcodes/47513

```
\x99\xf7\xe2\x8d\x08\xbe\x2f\x2f\x73\x68\xbf\x2f\x62\x69\x6e\x51\x56\x57\x8d\x1c\x24\xb0\x0b\xcd\x80
```
